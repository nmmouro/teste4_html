<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Painel Frota - Tempo Real</title>

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: Arial, sans-serif;
    }

    body {
      background: #000;
      color: #fff;
      overflow: hidden;
    }

    .container {
      padding: 10px;
    }

    .logo {
      text-align: center;
      margin-bottom: 10px;
    }

    .logo img {
      height: 70px;
    }

    .clock {
      text-align: center;
      font-size: 36px;
      margin-bottom: 10px;
      color: #0f0;
      font-weight: bold;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
    }

    .card {
      background: #111;
      border-radius: 10px;
      padding: 10px;
      overflow: hidden;
    }

    .card h2 {
      text-align: center;
      margin-bottom: 8px;
      font-size: 22px;
      color: #00ffff;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 16px;
    }

    th {
      background: #222;
      padding: 6px;
      text-align: center;
      font-size: 15px;
    }

    td {
      padding: 6px;
      text-align: center;
      border-bottom: 1px solid #333;
    }

    tr.status-andamento {
      background: #5c4d00;
      color: #fff;
      font-weight: bold;
    }

    tr.status-concluido {
      background: #003300;
      color: #fff;
      font-weight: bold;
    }
  </style>
</head>
<body>

<div class="container">

  <div class="logo">
    <!-- Troque o arquivo pelo logo da sua empresa -->
    <img src="logo.png" alt="Logo da Empresa">
  </div>

  <div class="clock" id="clock">--:--</div>

  <div class="grid">
    <div class="card">
      <h2>PAINEL</h2>
      <div id="painel"></div>
    </div>

    <div class="card">
      <h2>AGENDA DO DIA</h2>
      <div id="agenda"></div>
    </div>

    <div class="card">
      <h2>AGENDA SERVIÇO SOCIAL</h2>
      <div id="social"></div>
    </div>
  </div>

</div>

<script>
const SHEET_ID = "1Ch3AjQ0MDo4WuQWFDR3r8nZrHb4yQkSLOtT5_QgxT6E";

const ABAS = [
  { name: "PAINEL", div: "painel" },
  { name: "AGENDA DO DIA", div: "agenda" },
  { name: "AGENDA SERVIÇO SOCIAL", div: "social" }
];

// ===================== RELÓGIO =====================
function atualizarRelogio() {
  const agora = new Date();
  const h = String(agora.getHours()).padStart(2, "0");
  const m = String(agora.getMinutes()).padStart(2, "0");
  document.getElementById("clock").innerText = `${h}:${m}`;
}
setInterval(atualizarRelogio, 1000);
atualizarRelogio();

// ===================== HTML SAFE =====================
function escapeHtml(text) {
  if (text === null || text === undefined) return "";
  return String(text)
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;");
}

// ===================== FORMATAÇÃO DE CÉLULAS =====================
function formatCell(value) {
  if (value === null || value === undefined) return "";

  let v = String(value);

  // Trata Date(2025,10,11)
  const match = v.match(/Date\((\d+),(\d+),(\d+)\)/);
  if (match) {
    const ano = match[1];
    const mes = String(Number(match[2]) + 1).padStart(2, "0");
    const dia = String(match[3]).padStart(2, "0");
    return `${dia}/${mes}/${ano}`;
  }

  return v;
}

// ===================== RENDER TABELA =====================
function renderTabela(divId, cols, rows, nomeAba) {
  const div = document.getElementById(divId);

  let html = "<table><thead><tr>";
  cols.forEach(c => html += `<th>${escapeHtml(c)}</th>`);
  html += "</tr></thead><tbody>";

  rows.forEach(r => {
    let classe = "";
    const statusBruto = r[r.length - 1] ?? "";
    const status = String(statusBruto).toLowerCase();

    if (status.includes("andamento")) classe = "status-andamento";
    if (status.includes("concluído") || status.includes("concluido"))
      classe = "status-concluido";

    html += `<tr class="${classe}">`;

    r.forEach((cellValue, idx) => {
      let valor = formatCell(cellValue);

      // ✅ REGRA ESPECIAL → só na AGENDA DO DIA, coluna Hora
      if (
        nomeAba === "AGENDA DO DIA" &&
        cols[idx] &&
        cols[idx].toLowerCase().includes("hora")
      ) {
        // extrai apenas HH:MM
        const hora = valor.match(/(\d{1,2}):(\d{2})/);
        if (hora) {
          valor = `${hora[1].padStart(2, "0")}:${hora[2]}`;
        }
      }

      html += `<td>${escapeHtml(valor)}</td>`;
    });

    html += "</tr>";
  });

  html += "</tbody></table>";
  div.innerHTML = html;
}

// ===================== CARREGADOR =====================
function carregar(sheet, divId) {
  const url =
    `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?` +
    `tqx=out:json&sheet=${encodeURIComponent(sheet)}&nocache=` +
    new Date().getTime();

  fetch(url)
    .then(r => r.text())
    .then(text => {
      const json = JSON.parse(text.substring(47).slice(0, -2));

      const cols = json.table.cols.map(c => c.label || "");
      const rows = json.table.rows.map(r =>
        r.c.map(c => (c ? c.v : ""))
      );

      renderTabela(divId, cols, rows, sheet);
    })
    .catch(err => {
      document.getElementById(divId).innerHTML =
        `<div style="color:red">Erro ao carregar dados</div>`;
      console.error("Erro:", err);
    });
}

// ===================== ATUALIZAÇÃO AUTOMÁTICA =====================
function atualizarTudo() {
  ABAS.forEach(a => carregar(a.name, a.div));
}

atualizarTudo();
setInterval(atualizarTudo, 60000); // 1 minuto
</script>

</body>
</html>
